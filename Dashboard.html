<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Tableau de bord personnel pour la gestion de votre profil Mahu, de vos contacts et de vos statistiques.">
    <meta name="robots" content="noindex, nofollow"> <!-- Page privée, ne pas indexer -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tableau de Bord</title>
    <link rel="icon" href="r/logo.png" type="image/png">
    <style>
        /* Thème sombre par défaut */
        :root {
            --bg-main: #121212;
            --card-bg: #1E1E1E;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #444;
            --input-bg: rgba(0,0,0,0.2);
            --skeleton-bg: #3a3a3a;
            --skeleton-highlight: #4a4a4a;
            --phone-bg: #111;
            --social-icon-filter: invert(1);
            --sidebar-width-collapsed: 80px;
            --sidebar-width-expanded: 260px;
            --accent-color: #FFFFFF; /* Accent pour le mode sombre */
        }

        /* Thème clair */
        body.light-mode {
            --bg-main: #f4f7f6;
            --card-bg: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --input-bg: #f8f9fa;
            --skeleton-bg: #e0e0e0;
            --skeleton-highlight: #f0f0f0;
            --phone-bg: #ccc;
            --social-icon-filter: invert(0);
            --accent-color: #000000; /* Accent pour le mode clair */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background: var(--bg-main);
            background-attachment: fixed;
            color: var(--text-primary);
        }

        .dashboard-layout {
            display: flex;
        }

        /* Barre latérale */
        .sidebar {
            width: var(--sidebar-width-expanded);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Pour pousser la déconnexion en bas */
            z-index: 100;
        }

        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
            align-items: center;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 10px;
            height: 70px; /* Hauteur fixe pour l'alignement */
        }

        .sidebar h2 img {
            transition: transform 0.3s ease;
        }
        .sidebar h2:hover img {
            transform: scale(1.05);
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
        }

        .sidebar nav a svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        .sidebar nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .sidebar nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: bold;
        }

        .sidebar.collapsed nav a {
            justify-content: center; /* Centre l'icône quand replié */
        }

        .sidebar.collapsed nav a span {
            display: none; /* Cache le texte quand replié */
        }

        /* Contenu principal */
        .main-content {
            margin-left: var(--sidebar-width-expanded);
            flex-grow: 1;
            padding: 40px;
            box-sizing: border-box;
            transition: margin-left 0.3s ease;
        }

        /* Styles pour le bouton menu hamburger sur mobile */
        .menu-toggle {
            display: none; /* Caché par défaut sur grand écran */
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 101; /* Pour être au-dessus de la sidebar */
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .menu-toggle.moved {
            left: calc(var(--sidebar-width) + 20px);
        }

        /* Cartes de contenu */
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Styles spécifiques au Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-item { text-align: center; }
        .stat-item .number { font-size: 2.5em; font-weight: bold; color: var(--text-primary); }
        .stat-item .label { color: var(--text-secondary); }
        .toggle-switch { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--input-bg); }
        .btn { padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background-color: var(--accent-color); color: var(--bg-main); }
        .btn-secondary { background-color: var(--text-secondary); color: var(--card-bg); }

        /* Squelette de chargement pour la table des contacts */
        .skeleton-row td div {
            height: 20px;
            background-color: var(--skeleton-bg);
            border-radius: 4px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { background-color: var(--skeleton-bg); }
            50% { background-color: var(--skeleton-highlight); }
            100% { background-color: var(--skeleton-bg); }
        }

        .skeleton {
            display: inline-block;
            height: 1em;
            width: 70%;
            background-color: var(--skeleton-bg);
            border-radius: 4px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        /* Styles pour les onglets de contenu */
        .content-pane {
            padding-top: 20px; /* Ajoute de l'espace au-dessus de chaque panneau pour le défilement */
            margin-bottom: 40px; /* Espace entre les panneaux */
        }
        
        /* Styles du formulaire de l'éditeur */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
        .form-control {
            width: 100%; padding: 12px; background-color: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 5px;
            color: var(--text-primary); font-size: 1em; box-sizing: border-box; transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        textarea.form-control { min-height: 120px; resize: vertical; }

        .social-link-entry {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .btn-danger { background-color: #555; color: white; padding: 8px 12px; font-size: 0.9em; }
        .btn-danger:hover { background-color: #dc3545; }

        /* Nouveaux styles pour le panneau Profil */
        .profile-preview-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }
        .profile-main-card {
            position: relative;
            padding: 0;
            overflow: hidden;
        }
        .profile-cover-image {
            width: 100%;
            height: 200px;
            background-color: #333;
            background-size: cover;
            background-position: center;
        }
        .profile-picture-container {
            position: relative;
            margin-top: -60px;
            padding: 0 25px;
        }
        .profile-picture-container img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--card-bg);
            object-fit: cover;
        }
        .profile-info {
            padding: 15px 25px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .profile-info-text { flex-grow: 1; }
        .profile-info-text h2 { margin: 0 0 10px 0; }
        .profile-info-text p { margin: 0; color: var(--text-secondary); }
        .profile-info-qr {
            text-align: center;
        }
        .profile-info-qr img {
            width: 100px; height: 100px; border-radius: 8px;
        }

        /* Styles pour l'overlay de modification d'image */
        .edit-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .profile-picture-container .edit-overlay {
            top: 5px;
            right: 0;
            left: 85px; /* Positionne le bouton à droite de l'image de profil */
            width: 32px; /* Assure que le conteneur ne s'étire pas */
        }
        .edit-overlay-btn {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            line-height: 32px;
            text-align: center;
            cursor: pointer;
        }
        .edit-dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 10;
            overflow: hidden;
        }
        .edit-dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: var(--text-primary);
            text-decoration: none;
        }
        .edit-dropdown-menu a:hover { background-color: rgba(255,255,255,0.1); }

        .share-actions .btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%; /* Pour prendre toute la largeur sur mobile */
            margin-bottom: 10px;
            justify-content: center;
        }

        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%; background-color: #333; border-radius: 5px; overflow: hidden;
        }
        .progress-bar-inner {
            height: 10px; width: 0%; /* Défini par JS */
            background: var(--accent-color);
            transition: width 0.5s ease;
        }

        /* Nouveaux styles pour la fenêtre modale */
        .modal {
            display: none; /* Caché par défaut */
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 1100px; /* Augmenté pour la nouvelle interface */
            border-radius: 12px;
            animation: slideIn 0.4s;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-btn {
            color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        
        /* Nouveaux styles pour l'éditeur de profil modal */
        .modal-editor-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        .editor-nav {
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .editor-nav-btn {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        .editor-nav-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-color);
        }
        .edit-pane { display: none; }
        .edit-pane.active { display: block; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        /* Styles pour le simulateur de téléphone */
        .phone-preview {
            background-color: var(--phone-bg);
            border-radius: 40px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            height: fit-content;
        }
        .phone-screen {
            background-color: var(--card-bg);
            height: 600px;
            border-radius: 25px;
            display: flex;
            position: relative; /* Ajout pour le positionnement du bouton de fermeture */
        }
        .phone-screen-inner {
            flex-grow: 1;
            flex-direction: column;
            overflow: hidden; /* Empêche le défilement global */
        }
        .phone-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        .phone-header { text-align: center; padding: 0 20px 20px; }
        .phone-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent-color);
            object-fit: cover;
            margin-top: -40px; /* Fait remonter l'image sur la couverture */
            position: relative; /* Pour s'assurer qu'elle est au-dessus */
        }
        .phone-header h3 { margin: 10px 0 5px 0; font-size: 1.2em; }
        .phone-header p { margin: 0; font-size: 0.9em; color: var(--text-secondary); }
        
        /* Scrollbar pour le téléphone */
        .phone-scrollable-content::-webkit-scrollbar { width: 4px; }
        .phone-scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .phone-scrollable-content::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .phone-scrollable-content::-webkit-scrollbar-thumb:hover { background: #777; }

        .phone-cover { height: 120px; background-size: cover; background-position: center; }

        .phone-qr-section {
            padding: 20px;
            text-align: center;
            background-color: rgba(0,0,0,0.15);
            flex-shrink: 0; /* Empêche cette section de se réduire */
        }
        .phone-qr-section img {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .phone-qr-section p {
            margin: 0;
            font-weight: 500;
            color: var(--text-primary);
        }

        .phone-social-links {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
        }
        .phone-social-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--text-secondary);
        }
        .phone-social-link img.social-icon { /* Cible pour les nouvelles icônes SVG */
            width: 20px;
            height: 20px;
            filter: var(--social-icon-filter); /* Assure que les icônes sont blanches par défaut */
            margin-bottom: 5px;
        }
        .phone-social-link span {
            font-size: 0.75em;
            text-align: center;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(calc(-1 * var(--sidebar-width-expanded)));
                transition: transform 0.3s ease;
            }
        .menu-toggle {
            display: flex; /* Afficher le bouton sur mobile */
        }
            .sidebar.visible {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            padding: 20px;
        }
        .main-content.collapsed { margin-left: 0 !important; }

            .profile-preview-grid {
                grid-template-columns: 1fr;
            }
            .modal-editor-layout {
                display: flex;
                flex-direction: column-reverse; /* Met le téléphone en haut sur mobile */
            }
            .phone-preview {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
            margin: 10% auto; /* Moins de marge en haut sur mobile */
        }
        .share-actions {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Deux boutons par ligne pour le partage */
            gap: 10px; /* Ajoute un espace entre les boutons */
            }
            .profile-picture-container .edit-overlay {
                left: auto; /* Annule le positionnement à gauche */
                right: calc(50% - 60px); /* Centre le bouton par rapport à l'image */
                transform: translateX(100%);
            }
            .phone-screen {
                height: 500px; /* Réduit la hauteur sur les petits écrans */
            }
            .modal-editor-layout > form {
                max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <div class="menu-toggle" onclick="toggleSidebar()">☰</div>
        <aside class="sidebar">
            <h2><img src="r/logo.png" alt="Logo Brunel" style="height: 70px;"></h2>
            <nav>
                <a href="#" class="active" onclick="showPane(event, 'profil-content', this)" title="Profil">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    <span>Profil</span>
                </a>
                <a href="#" onclick="showPane(event, 'contact-content', this)" title="Contacts">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>Contacts</span>
                </a>
                <a href="#" onclick="showPane(event, 'statistique-content', this)" title="Statistiques">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    <span>Statistiques</span>
                </a>
                <a href="#" onclick="showPane(event, 'integration-content', this)" title="Intégrations">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <span>Intégrations</span>
                </a>
                <a href="#" onclick="showPane(event, 'boutique-content', this)" title="Boutique">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span>Boutique</span>
                </a>
                <a href="#" onclick="showPane(event, 'parametre-content', this)" title="Paramètres">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    <span>Paramètres</span>
                </a>
            </nav>
            <nav> <!-- Conteneur séparé pour le bouton de déconnexion -->
                <a href="#" onclick="logout()" title="Déconnexion">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Déconnexion</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Panneau Profil (Aperçu) -->
            <div id="profil-content" class="content-pane">
                <h1>Profil</h1>
                <div class="progress-bar-container">
                    <p>Complétion du profil : <span id="profile-completeness-percent">...</span></p>
                    <div class="progress-bar"><div id="profile-completeness-bar" class="progress-bar-inner"></div></div>
                </div>
                <div class="profile-preview-grid">
                    <!-- Colonne principale -->
                    <div class="profile-main-column">
                        <div class="card profile-main-card">
                            <div id="profile-cover-preview" class="profile-cover-image" style="background-image: url('https://placehold.co/800x300/333/ccc?text=Couverture');">
                                <div class="edit-overlay">
                                    <button class="edit-overlay-btn" onclick="toggleEditMenu(event, 'cover-edit-menu')">+</button>
                                    <div id="cover-edit-menu" class="edit-dropdown-menu">
                                        <a href="#" onclick="triggerFileInput('cover-image-input')">Modifier</a>
                                        <a href="#" onclick="deleteImage(event, 'cover')">Supprimer</a>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-picture-container">
                                <img id="profile-picture-preview" src="https://placehold.co/150x150/333/ccc?text=Profil" alt="Photo de profil">
                                <div class="edit-overlay">
                                    <button class="edit-overlay-btn" onclick="toggleEditMenu(event, 'picture-edit-menu')">+</button>
                                    <div id="picture-edit-menu" class="edit-dropdown-menu">
                                        <a href="#" onclick="triggerFileInput('profile-picture-input')">Modifier</a>
                                        <a href="#" onclick="deleteImage(event, 'picture')">Supprimer</a>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-info">
                                <div class="profile-info-text">
                                    <h2 id="profile-name-preview">Nom Prénom</h2>
                                    <p id="profile-details-preview">Profession | Entreprise | Lieu</p>
                                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="openModal('profil-edit-modal');">Modifier le Profil</button>
                                </div>
                                <div class="profile-info-qr">
                                    <img id="profile-qrcode" src="https://placehold.co/150x150/333/ccc?text=QR" alt="QR Code">
                                    <a id="download-qrcode-btn" href="#" download="qrcode-mahu.png" style="font-size: 0.8em; color: var(--text-secondary); display: block; margin-top: 5px;">Télécharger</a>
                                </div>
                            </div>
                    </div>
                    <!-- Inputs cachés pour le changement d'image direct -->
                    <input type="file" id="profile-picture-input" accept="image/*" style="display:none;" onchange="handleDirectImageChange(event, 'picture')">
                    <input type="file" id="cover-image-input" accept="image/*" style="display:none;" onchange="handleDirectImageChange(event, 'cover')">

                    <!-- Colonne latérale -->
                    <div class="profile-sidebar-column">
                        <div class="card">
                            <h3>Partager le Profil</h3>
                            <div class="share-actions">
                                <a id="share-link" href="#" class="btn btn-secondary">Copier le lien</a>
                                <a id="share-email" href="#" class="btn btn-secondary">Partager par Email</a>
                                <a id="share-sms" href="#" class="btn btn-secondary">Partager par SMS</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panneau Contacts -->
            <div id="contact-content" class="content-pane">
                <h1>Contacts</h1>
                <div class="card">
                    <h3>Mes Prospects</h3>
                    <button class="btn btn-secondary" style="float: right; margin-bottom: 15px;" onclick="exportLeads()">Exporter en CSV</button>
                    <div style="overflow-x:auto;">
                        <table>
                        <thead>
                            <tr>
                                <th>Nom du Prospect</th>
                                <th>Contact (Email/Tél)</th>
                                <th>Date</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="prospects-table-body">
                            <tr class="skeleton-row"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Panneau Statistiques -->
            <div id="statistique-content" class="content-pane">
                <h1>Statistiques</h1>
                <div class="card">
                    <h3>Aperçu Général</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div id="stats-total-views" class="number"><span class="skeleton" style="width: 60px; height: 40px;"></span></div>
                            <div class="label">Vues Totales</div>
                        </div>
                        <div class="stat-item">
                            <div id="stats-total-prospects" class="number"><span class="skeleton" style="width: 60px; height: 40px;"></span></div>
                            <div class="label">Prospects Capturés</div>
                        </div>
                        <div class="stat-item">
                            <div id="stats-nfc-views" class="number"><span class="skeleton" style="width: 60px; height: 40px;"></span></div>
                            <div class="label">Vues via NFC</div>
                        </div>
                        <div class="stat-item">
                            <div id="stats-qr-views" class="number"><span class="skeleton" style="width: 60px; height: 40px;"></span></div>
                            <div class="label">Vues via QR Code</div>
                        </div>
                        <div class="stat-item">
                            <div id="stats-link-views" class="number"><span class="skeleton" style="width: 60px; height: 40px;"></span></div>
                            <div class="label">Vues via Lien</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Vues par source (Graphique)</h3>
                    <canvas id="viewsChart" style="margin-top: 20px;"></canvas>
                </div>
            </div>

            <!-- Panneau Intégrations -->
            <div id="integration-content" class="content-pane">
                <h1>Intégrations</h1>
                <p style="max-width: 100%; text-align: left; margin-bottom: 20px; color: var(--text-secondary);">Connectez Mahu à d'autres services. Les clés API sont stockées de manière sécurisée et ne sont jamais partagées publiquement.</p>
                <div class="card">
                    <h3>Intégrations disponibles</h3>
                    <p>La possibilité d'ajouter votre carte à <strong>Google Wallet</strong> et <strong>Apple Wallet</strong> est disponible directement dans l'onglet "Paramètres".</p>
                    <p>Nous travaillons à l'ajout de nouvelles intégrations pour enrichir votre expérience. Revenez bientôt !</p>
                    <!-- Le formulaire de configuration a été retiré pour simplifier l'interface. La configuration se fait côté serveur. -->
                </div>
            </div>

            <!-- Panneau Boutique -->
            <div id="boutique-content" class="content-pane">
                <h1>Ma Boutique</h1>
                <div class="card">
                    <h3>Mes Produits</h3>
                    <p>Gérez ici les produits et articles de votre boutique. Ils apparaîtront sur votre page boutique publique si le module est activé.</p>
                    <button class="btn btn-primary" style="float: right; margin-bottom: 15px;" onclick="openProductModal()">Ajouter un produit</button>
                    <div id="product-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; clear: both;">
                        <!-- Les produits chargés par JS apparaîtront ici -->
                    </div>
                </div>
            </div>

            <!-- Panneau Paramètres -->
            <div id="parametre-content" class="content-pane">
                <h1>Paramètres</h1>
                <div class="card">
                    <h3>Mon Compte</h3>
                    <p>Email du compte : <strong id="account-email">...</strong></p>
                    <button class="btn btn-secondary" style="margin-top: 15px;" disabled>Changer le mot de passe (à venir)</button>
                </div>
                <div class="card">
                    <h3>Apparence</h3>
                    <button id="theme-toggle-btn" class="btn btn-secondary" onclick="toggleTheme()">Passer au mode clair</button>
                </div>
                <div class="card">
                    <h3>Gestion des Modules</h3>
                    <div class="toggle-switch">
                        <span>Module CV/Portfolio</span>
                        <input type="checkbox" id="toggle-cv" onchange="toggleModule('CV_Actif', this.checked)">
                    </div>
                    <div class="toggle-switch">
                        <span>Capture de prospects</span>
                        <input type="checkbox" id="toggle-lead" onchange="toggleModule('Lead_Capture_Actif', this.checked)">
                    </div>
                    <div class="toggle-switch">
                        <span>Module Boutique</span>
                        <input type="checkbox" id="toggle-shop" onchange="toggleModule('Boutique_Active', this.checked)">
                    </div>
                </div>
                <div class="card">
                   <h3>Votre Carte Numérique (Wallet)</h3>
                   <p>Ajoutez votre carte de visite Mahu à votre portefeuille numérique pour un accès rapide et facile.</p>
                   <div style="display: flex; gap: 15px; margin-top: 20px;">
                       <button id="apple-wallet-btn" class="btn" onclick="addToAppleWallet()" style="flex: 1;">Ajouter à Apple Wallet</button>
                       <button id="google-wallet-btn" class="btn" onclick="addToGoogleWallet()" style="flex: 1;">Ajouter à Google Wallet</button>
                   </div>
               </div>
               <div class="card">
                   <h3>Mes Cartes NFC</h3>
                   <ul id="nfc-card-list">
                       <li>Chargement des cartes...</li>
                   </ul>
                   <button class="btn btn-primary" onclick="linkNewNFC()" style="margin-top: 15px;">Lier une nouvelle carte</button>
               </div>
               <div class="card">
                   <h3>Demande de Carte</h3>
                   <p><strong>Statut de la dernière commande :</strong> <span id="order-status">Aucune commande récente.</span></p>
                   <button class="btn btn-primary" onclick="window.location.href='Boutique.html'" style="margin-top: 15px;">Commander une nouvelle carte</button>
               </div>
            </div>
            
        </main>
    </div>

    <!-- Fenêtre Modale pour l'édition du profil -->
    <div id="profil-edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('profil-edit-modal')">&times;</span>
            <h1>Modifier le Profil</h1>
            <div class="editor-nav">
                <button class="editor-nav-btn active" onclick="showEditPane('edit-pane-about', this)">À propos</button>
                <button class="editor-nav-btn" onclick="showEditPane('edit-pane-appearance', this)">Apparence</button>
                <!-- L'onglet "Liens" a été fusionné avec "À propos" -->
            </div>
            <div class="modal-editor-layout">
                <form id="profile-form" onsubmit="handleSave(event)">
                    <!-- Panneau d'édition "À propos" -->
                    <div id="edit-pane-about" class="edit-pane active">
                        <h3>Contenu Principal</h3>
                        <div class="form-group"><label for="Nom_Complet">Nom complet</label><input type="text" id="Nom_Complet" name="Nom_Complet" class="form-control" placeholder="Ex: Jean Dupont"></div>
                        <div class="form-group"><label for="URL_Profil">URL du profil personnalisée</label><input type="text" id="URL_Profil" name="URL_Profil" class="form-control" placeholder="Ex: jean-dupont (lettres, chiffres et tirets uniquement)"></div>
                        <div class="form-group"><label for="Profession">Profession</label><input type="text" id="Profession" name="Profession" class="form-control" placeholder="Ex: Développeur Web"></div>
                        <div class="form-group"><label for="Compagnie">Compagnie</label><input type="text" id="Compagnie" name="Compagnie" class="form-control" placeholder="Ex: Mahu Inc."></div>
                        <div class="form-group"><label for="Location">Location</label><input type="text" id="Location" name="Location" class="form-control" placeholder="Ex: Paris, France"></div>
                        
                        <h3 style="margin-top: 30px;">Réseaux Sociaux & Liens</h3>
                        <div id="social-links-container"></div>
                        <button type="button" class="btn btn-secondary" onclick="addSocialLink()" style="width: auto; margin-top: 10px;">Ajouter un lien</button>

                    </div>
                    <!-- Panneau d'édition "Apparence" -->
                    <div id="edit-pane-appearance" class="edit-pane">
                        <h3>Apparence</h3>
                        <p class="text-secondary" style="color: var(--text-secondary); margin-top:-10px; margin-bottom: 20px;">Personnalisez l'aspect et la convivialité de votre profil.</p>

                        <h4>Mise en page</h4>
                        <p class="text-secondary" style="color: var(--text-secondary); margin-top:-10px; margin-bottom: 10px;">Modifier l'affichage de votre profil.</p>
                        <!-- Options de mise en page (simplifiées) -->
                        <select name="Mise_En_Page" class="form-control">
                            <option value="default">Mise en page par défaut</option>
                            <option value="fullscreen_photo">Photo de profil en plein écran</option>
                            <option value="fullscreen_bg">Arrière-plan en plein écran</option>
                        </select>

                        <h4 style="margin-top: 25px;">Typographie</h4>
                        <p class="text-secondary" style="color: var(--text-secondary); margin-top:-10px; margin-bottom: 10px;">Modifier la police et les couleurs du texte de votre profil.</p>
                        <div class="form-grid">
                            <div class="form-group"><label for="Couleur_Theme">Couleur du Thème</label><input type="color" id="Couleur_Theme" name="Couleur_Theme" class="form-control" value="#007BFF" style="padding: 5px; height: 45px;"></div>
                        </div>

                        <h4 style="margin-top: 25px;">Marque</h4>
                        <div class="toggle-switch"><span>Cacher la marque Mahu</span><input type="checkbox" id="toggle-branding"></div>

                        <div class="form-group" style="margin-top: 25px;"><label for="Langue">Langue</label><select id="Langue" name="Langue" class="form-control"><option value="fr">Français</option><option value="en">English</option></select></div>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 30px 0;">
                    <button type="submit" id="save-button" class="btn btn-primary">Sauvegarder les changements</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profil-edit-modal')" style="margin-left: 10px;">Annuler</button>
                </form>
                <div class="phone-preview">
                    <div class="phone-screen">
                        <div class="phone-screen-inner">
                            <div class="phone-qr-section">
                                <img id="phone-qrcode-preview" src="https://placehold.co/150x150/333/ccc?text=QR" alt="Aperçu QR Code">
                                <p>Mon QR Code</p>
                            </div>
                            <div class="phone-scrollable-content">
                                <div id="phone-cover-preview" class="phone-cover" style="background-image: url('https://placehold.co/800x300/333/ccc?text=Couverture');"></div>
                                <div class="phone-header">
                                    <img id="phone-picture-preview" src="https://placehold.co/150x150/333/ccc?text=Profil" alt="Aperçu profil">
                                    <h3 id="phone-name-preview">Nom Prénom</h3>
                                    <p id="phone-details-preview">Profession</p>
                                </div>
                                <div id="phone-social-links-preview" class="phone-social-links"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fenêtre Modale pour l'ajout/édition de produit -->
    <div id="product-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="closeModal('product-modal')">&times;</span>
            <h1 id="product-modal-title">Ajouter un produit</h1>
            <form id="product-form" onsubmit="handleProductSave(event)">
                <input type="hidden" id="product-id" name="product-id">
                <div class="form-group">
                    <label for="product-name">Nom du produit</label>
                    <input type="text" id="product-name" name="product-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Prix (en €)</label>
                    <input type="number" id="product-price" name="product-price" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="product-description">Description</label>
                    <textarea id="product-description" name="product-description" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label>Images (jusqu'à 5)</label>
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: -8px;">La première image sera l'image principale.</p>
                    <div id="product-image-inputs">
                        <input type="file" name="product-image-1" class="form-control" accept="image/*" onchange="previewProductImage(this, 1)">
                        <!-- D'autres inputs seront ajoutés par JS si besoin -->
                    </div>
                    <div id="product-image-previews" style="display: flex; gap: 10px; margin-top: 10px;">
                        <!-- Les aperçus d'images apparaîtront ici -->
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 30px 0;">
                <button type="submit" id="product-save-button" class="btn btn-primary">Sauvegarder le produit</button>
                <button type="button" class="btn btn-danger" id="product-delete-button" onclick="handleProductDelete()" style="display: none; margin-left: 10px;">Supprimer</button>
            </form>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        /**
         * Fonction centralisée pour appeler l'API backend via POST.
         * @param {string} action - Le nom de l'action à exécuter côté serveur.
         * @param {Object} [data={}] - Un objet contenant les données à envoyer.
         * @returns {Promise<Object>} Une promesse qui se résout avec la réponse JSON de l'API.
         */
        function callApi(action, data = {}) {
            const formData = new FormData();
            const token = localStorage.getItem('authToken');
            if (!token && action !== 'loginUser' && action !== 'registerUser') {
                // Si pas de token et que l'action n'est pas une connexion/inscription, rediriger.
                window.location.href = 'Connexion.html';
            }
            formData.append('action', action);

            // Ajouter chaque clé de l'objet data au FormData
            for (const key in data) {
                // Si la valeur est un objet, la stringifier en JSON
                const value = typeof data[key] === 'object' ? JSON.stringify(data[key]) : data[key];
                formData.append(key, value);
            }
            formData.append('token', token); // Ajouter le token à chaque requête !

            return fetch(API_URL, { method: 'POST', body: formData }).then(res => res.json());
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuToggle = document.querySelector('.menu-toggle');
            
            const isCollapsed = sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed', isCollapsed);
            menuToggle.classList.toggle('collapsed', isCollapsed);

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('visible');
            }

            // Sauvegarder l'état dans le localStorage
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        // Au chargement de la page, vérifier l'état sauvegardé
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('sidebarCollapsed') === 'true' && window.innerWidth > 768) {
                toggleSidebar();
            }
            // Appliquer le thème sauvegardé
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-toggle-btn').textContent = 'Passer au mode sombre';
            }
        });

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (isLight) {
                localStorage.setItem('theme', 'light');
                themeToggleBtn.textContent = 'Passer au mode sombre';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggleBtn.textContent = 'Passer au mode clair';
            }
        }

        function showPane(event, paneId, clickedElement) {
            event.preventDefault(); // Empêche le comportement par défaut du lien

            const targetPane = document.getElementById(paneId);
            if (targetPane) {
                // Fait défiler la vue jusqu'au panneau cible
                targetPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Met à jour l'état "actif" dans la barre latérale pour indiquer la section visible
            document.querySelectorAll('.sidebar nav a').forEach(link => link.classList.remove('active'));
            clickedElement.classList.add('active');

            // Sur mobile, refermer la barre latérale après avoir cliqué sur un lien
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('visible');
            }
        }

        function toggleModule(moduleName, isEnabled) {
            const dataToSave = {};
            // Convertit le booléen en 'OUI' ou 'NON' pour la feuille de calcul
            dataToSave[moduleName] = isEnabled ? 'OUI' : 'NON';

            // Affiche un message rapide pour informer l'utilisateur
            alert("Sauvegarde du paramètre...");

            callApi('saveProfile', dataToSave)
                .then(response => {
                    if (response.success) {
                        alert('Paramètre sauvegardé avec succès !');
                    } else {
                        alert('Erreur : ' + (response.error || 'Impossible de sauvegarder le paramètre.'));
                        // En cas d'erreur, on remet l'interrupteur à son état précédent
                        const checkbox = document.getElementById(moduleName === 'CV_Actif' ? 'toggle-cv' : 'toggle-lead');
                        checkbox.checked = !isEnabled;
                    }
                })
                .catch(err => {
                    alert('Erreur de communication avec le serveur.');
                    const checkbox = document.getElementById(moduleName === 'CV_Actif' ? 'toggle-cv' : 'toggle-lead');
                    checkbox.checked = !isEnabled;
                });
        }

        function addSocialLink(type = 'website', url = '') {
            const container = document.getElementById('social-links-container');
            const newLinkEntry = document.createElement('div');
            newLinkEntry.className = 'social-link-entry';

            const uniqueId = 'social_' + Date.now();

            const selectHTML = `
                <select class="form-control" name="social_type_${uniqueId}" onchange="updatePhoneSocialLinks()">
                    <option value="website" ${type === 'website' ? 'selected' : ''}>Site Web</option>
                    <option value="linkedin" ${type === 'linkedin' ? 'selected' : ''}>LinkedIn</option>
                    <option value="github" ${type === 'github' ? 'selected' : ''}>GitHub</option>
                    <option value="twitter" ${type === 'twitter' ? 'selected' : ''}>X (Twitter)</option>
                    <option value="instagram" ${type === 'instagram' ? 'selected' : ''}>Instagram</option>
                    <option value="facebook" ${type === 'facebook' ? 'selected' : ''}>Facebook</option>
                    <option value="tiktok" ${type === 'tiktok' ? 'selected' : ''}>TikTok</option>
                    <option value="youtube" ${type === 'youtube' ? 'selected' : ''}>YouTube</option>
                    <option value="whatsapp" ${type === 'whatsapp' ? 'selected' : ''}>WhatsApp</option>
                    <option value="telegram" ${type === 'telegram' ? 'selected' : ''}>Telegram</option>
                    <option value="snapchat" ${type === 'snapchat' ? 'selected' : ''}>Snapchat</option>
                    <option value="other" ${type === 'other' ? 'selected' : ''}>Lien personnalisé</option>
                </select>
            `;

            newLinkEntry.innerHTML = `
                ${selectHTML}
                <input type="text" class="form-control" name="social_url_${uniqueId}" placeholder="Ex: instagram.com/profil" value="${url}" oninput="updatePhoneSocialLinks()">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); updatePhoneSocialLinks();">✕</button>
            `;
            container.appendChild(newLinkEntry);
        }

        function handleSave(event) {
            event.preventDefault();
            const button = document.getElementById('save-button');
            button.textContent = 'Sauvegarde en cours...';
            button.disabled = true;

            const profileForm = document.getElementById('profile-form');

            const profileData = {
                // Panneau "À propos"
                Nom_Complet: profileForm.Nom_Complet.value,
                URL_Profil: profileForm.URL_Profil.value, // Ajout du nouveau champ
                Profession: profileForm.Profession.value,
                Compagnie: profileForm.Compagnie.value,
                Location: profileForm.Location.value,

                // Panneau "Apparence"
                Mise_En_Page: profileForm.Mise_En_Page.value,
                // Police: profileForm.Police.value, // Champ Police n'existe pas dans le HTML
                Couleur_Theme: profileForm.Couleur_Theme.value, // Nouveau champ
                Cacher_Marque: document.getElementById('toggle-branding').checked,
                Langue: profileForm.Langue.value,

                // Panneau "Liens"
                Liens_Sociaux_JSON: getSocialLinksData()

                // La configuration du Wallet est maintenant gérée côté serveur, plus besoin de l'envoyer depuis le client.
            };
            
            // La gestion des images se fait maintenant via handleDirectImageChange
            // Il n'y a plus de fichiers à uploader depuis ce formulaire.
            // On sauvegarde directement les autres données.
            saveDataToSheet(profileData, button);
        }

        function uploadToImgBB(file) {
            return new Promise((resolve, reject) => {
                const apiKey = '96ff1e4e9603661db4d410f53df99454'; // Clé API ImgBB directement dans le code
                const formData = new FormData();
                formData.append('image', file);

                fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        resolve(result.data.url);
                    } else {
                        reject(new Error('Erreur ImgBB: ' + result.error.message));
                    }
                })
                .catch(reject);
            });
        }

        /**
         * Affiche ou cache le menu d'édition pour les images.
         */
        function toggleEditMenu(event, menuId) {
            event.preventDefault();
            event.stopPropagation();
            const menu = document.getElementById(menuId);
            // Cache tous les autres menus ouverts
            document.querySelectorAll('.edit-dropdown-menu').forEach(m => {
                if (m.id !== menuId) m.style.display = 'none';
            });
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Ferme les menus si on clique ailleurs
        window.addEventListener('click', () => {
            document.querySelectorAll('.edit-dropdown-menu').forEach(m => m.style.display = 'none');
        });

        /**
         * Déclenche le clic sur un input file caché.
         */
        function triggerFileInput(inputId) {
            event.preventDefault();
            document.getElementById(inputId).click();
        }

        /**
         * Gère le changement d'image depuis l'aperçu et lance la sauvegarde.
         */
        function handleDirectImageChange(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Mettre à jour l'aperçu
            const previewUrl = URL.createObjectURL(file);
            if (type === 'picture') {
                document.getElementById('profile-picture-preview').src = previewUrl;
            } else {
                document.getElementById('profile-cover-preview').style.backgroundImage = `url('${previewUrl}')`;
            }

            // Uploader et sauvegarder
            alert('Mise à jour de l\'image en cours...');
            uploadToImgBB(file).then(url => {
                // Utilise la nouvelle fonction avec le format attendu par le backend
                saveImageData(type, url);
            }).catch(err => alert("Erreur d'upload: " + err.message));
        }

        function deleteImage(event, type) {
            event.preventDefault();
            if (!confirm("Voulez-vous vraiment supprimer cette image ?")) return;
            // Utilise la nouvelle fonction en passant une URL vide pour supprimer
            saveImageData(type, '');
        }

        function exportLeads() {
            // TODO: Implémenter la logique d'exportation des prospects en CSV.
            alert("La fonctionnalité d'exportation en CSV est en cours de développement.");
        }

        // Fonction dédiée à la sauvegarde des données d'image via la nouvelle action
        function saveImageData(imageType, imageUrl) {
            const payload = { imageType: imageType, imageUrl: imageUrl };
            callApi('saveProfileImage', { payload: payload })
                .then(response => {
                    alert(response.error || response.message || 'Image sauvegardée !');
                    fetchDashboardData(); // Recharger les données pour afficher la nouvelle image
                })
                .catch(err => alert('Erreur de sauvegarde de l\'image: ' + (err.message || "Erreur inconnue")));
        }

        function saveDataToSheet(data, button) {
            const saveButton = button || document.getElementById('save-button'); // Utilise le bouton passé ou le bouton par défaut
            if (saveButton) {
                saveButton.textContent = 'Sauvegarde en cours...';
                saveButton.disabled = true;
            }
            callApi('saveProfile', data) // Envoyer directement l'objet de données sans les infos Wallet
                .then(response => {
                    alert(response.error || response.message || 'Profil sauvegardé !');
                    closeModal('profil-edit-modal');
                    fetchDashboardData(); // Recharger les données
                })
                .catch(err => alert('Erreur de sauvegarde: ' + (err.message || "Erreur inconnue")))
                .finally(() => {
                    if (saveButton) { saveButton.textContent = 'Sauvegarder les changements'; saveButton.disabled = false; }
                });
        }
    </script>

    <script>
        // --- Logique pour les Wallets ---
        function addToAppleWallet() {
            alert("L'intégration avec Apple Wallet nécessite un service serveur dédié. Cette fonctionnalité est en cours de développement.");
        }

        function addToGoogleWallet() {
            const button = document.getElementById('google-wallet-btn');
            button.textContent = 'Génération...';
            button.disabled = true;

            callApi('generateGoogleWalletPass')
                .then(response => {
                    if (response.success) {
                        window.open(`https://pay.google.com/gp/v/save/${response.jwt}`, '_blank');
                    } else {
                        alert("Erreur lors de la génération de la carte Google Wallet : " + response.error);
                    }
                    button.textContent = 'Add to Google Wallet';
                    button.disabled = false;
                })
                .catch(err => alert('Erreur de communication avec le serveur.'));
        } 
    </script>
    
    <!-- Intégration de Chart.js et appel à Apps Script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        let viewsChartInstance = null; // Variable pour stocker l'instance du graphique

        document.addEventListener('DOMContentLoaded', function() {
            fetchDashboardData();
            feather.replace();
        });

        function fetchDashboardData() {
            callApi('getDashboardData')
                .then(populateDashboard) // populateDashboard gère déjà les erreurs renvoyées par l'API
                .catch(onDashboardError); // Gère les erreurs réseau ou les problèmes de parsing JSON
        }


        function onDashboardError(error) {
            console.error("Erreur de chargement du dashboard:", error.message);
            // Affiche un message plus utile à l'utilisateur
            alert("Impossible de charger les données du tableau de bord. Erreur : " + error.message);
        }

        /**
         * Cache les squelettes de chargement à l'intérieur d'un conteneur spécifique.
         * @param {string} containerSelector - Le sélecteur CSS du conteneur (ex: '#profil-content').
         */
        function hideSkeletons(containerSelector) {
            document.querySelectorAll(`${containerSelector} .skeleton, ${containerSelector} .skeleton-row`).forEach(el => el.style.display = 'none');
        }
        function populateDashboard(data) {
            if (data.error) {
                onDashboardError({ message: data.error });
                return;
            }

            // --- Remplir le panneau d'aperçu du profil ---
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const fullUrl = `${baseUrl}ProfilePublic.html?user=${data.user.URL_Profil}`;

            // Aperçu
            document.getElementById('profile-picture-preview').src = data.profile.URL_Photo || 'https://placehold.co/150x150/333/ccc?text=Profil';
            document.getElementById('profile-cover-preview').style.backgroundImage = `url('${data.profile.URL_Couverture || 'https://placehold.co/800x300/333/ccc?text=Couverture'}')`;
            document.getElementById('profile-name-preview').textContent = data.profile.Nom_Complet || 'Nom non défini';
            const subtitleParts = [data.profile.Profession, data.profile.Compagnie, data.profile.Location].filter(Boolean);
            document.getElementById('profile-details-preview').textContent = subtitleParts.join(' | ') || 'Informations non disponibles';

            // Actions de partage
            // Utilisation de quickchart.io pour un QR code avec logo. On construit l'URL absolue du logo.
            const logoUrl = new URL('r/logo.png', window.location.href).href;
            document.getElementById('profile-qrcode').src = `https://quickchart.io/qr?text=${encodeURIComponent(fullUrl)}&logo=${logoUrl}&size=250&centerImage=true`;
            document.getElementById('phone-qrcode-preview').src = `https://quickchart.io/qr?text=${encodeURIComponent(fullUrl)}&size=150`;
            
            // Générer le lien de téléchargement en haute résolution
            const highResQrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(fullUrl)}&logo=${logoUrl}&size=1024&format=png&centerImage=true`;
            document.getElementById('download-qrcode-btn').href = highResQrUrl;

            const shareLinkBtn = document.getElementById('share-link');
            shareLinkBtn.onclick = () => { navigator.clipboard.writeText(fullUrl); alert('Lien copié !'); };
            document.getElementById('share-email').href = `mailto:?subject=Découvrez mon profil Brunel&body=Voici mon profil numérique : ${fullUrl}`;
            document.getElementById('share-sms').href = `sms:?&body=Voici mon profil numérique : ${fullUrl}`;

            // Barre de progression
            let completeness = 0;
            if (data.profile.Nom_Complet) completeness += 20;
            if (data.profile.URL_Photo) completeness += 20;
            if (data.profile.URL_Couverture) completeness += 20;
            if (subtitleParts.length > 0) completeness += 20;
            if (JSON.parse(data.profile.Liens_Sociaux || '[]').length > 0) completeness += 20;
            document.getElementById('profile-completeness-percent').textContent = `${completeness}%`;
            document.getElementById('profile-completeness-bar').style.width = `${completeness}%`;


            // Remplir l'éditeur de profil
            // Panneau "À propos"
            document.getElementById('Nom_Complet').value = data.profile.Nom_Complet || '';
            document.getElementById('URL_Profil').value = data.user.URL_Profil || ''; // Remplir le champ URL
            document.getElementById('Profession').value = data.profile.Profession || '';
            document.getElementById('Compagnie').value = data.profile.Compagnie || '';
            document.getElementById('Location').value = data.profile.Location || '';
            // Panneau "Apparence"
            // Remplir les champs d'apparence avec les données sauvegardées (ou des valeurs par défaut)
            document.querySelector('select[name="Mise_En_Page"]').value = data.profile.Mise_En_Page || 'default';
            document.getElementById('Couleur_Theme').value = data.profile.Couleur_Theme || '#007BFF';

            // Remplir l'aperçu du téléphone
            document.getElementById('phone-picture-preview').src = data.profile.URL_Photo || 'https://placehold.co/150x150/333/ccc?text=Profil';
            document.getElementById('phone-cover-preview').style.backgroundImage = `url('${data.profile.URL_Couverture || 'https://placehold.co/800x300/333/ccc?text=Couverture'}')`;
            document.getElementById('phone-name-preview').textContent = data.profile.Nom_Complet || 'Nom non défini';
            const phoneSubtitleParts = [data.profile.Profession, data.profile.Compagnie, data.profile.Location].filter(Boolean);
            document.getElementById('phone-details-preview').textContent = phoneSubtitleParts.join(' | ') || 'Informations non disponibles';
            document.querySelector('.phone-header img').style.borderColor = data.profile.Couleur_Theme || 'var(--accent-color)'; // Utilise la couleur du thème
            
            // Remplir les liens sociaux dans l'éditeur
            updatePhoneSocialLinks(); // Mettre à jour l'aperçu

            document.getElementById('social-links-container').innerHTML = ''; // Vider avant de remplir
            const socialLinks = JSON.parse(data.profile.Liens_Sociaux || '[]');
            socialLinks.forEach(link => {
                addSocialLink(link.type, link.url);
            });

            // Remplir la liste des cartes NFC
            const nfcList = document.getElementById('nfc-card-list');
            const nfcCards = JSON.parse(data.user.ID_Cartes_NFC || '[]');
            nfcList.innerHTML = '';
            if (nfcCards.length > 0) {
                nfcCards.forEach(cardId => {
                    nfcList.innerHTML += `<li>Carte NFC #${cardId}</li>`;
                });
            } else {
                nfcList.innerHTML = '<li>Aucune carte NFC liée.</li>';
            }

            // Remplir la table des prospects
            const prospectsBody = document.getElementById('prospects-table-body');
            prospectsBody.innerHTML = ''; // Vider le contenu précédent

            if (data.prospects.length > 0) {
                data.prospects.forEach(p => {
                    prospectsBody.innerHTML += `<tr><td>${p.nom || ''}</td><td>${p.contact || ''}</td><td>${new Date(p.date).toLocaleDateString()}</td><td>${p.note || ''}</td></tr>`;
                });
            } else {
                prospectsBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Aucun prospect pour le moment.</td></tr>';
            }

            // Mettre à jour les toggles des modules
            document.getElementById('toggle-cv').checked = data.profile.CV_Actif === 'OUI';
            document.getElementById('toggle-lead').checked = data.profile.Lead_Capture_Actif === 'OUI';
            document.getElementById('toggle-shop').checked = data.profile.Boutique_Active === 'OUI';


            // Remplir les paramètres
            document.getElementById('account-email').textContent = data.user.Email;

            // Cacher les squelettes uniquement pour les panneaux qui ont été remplis
            hideSkeletons('#profil-content');
            hideSkeletons('#contact-content');
            hideSkeletons('#statistique-content');
            hideSkeletons('#integration-content');
            hideSkeletons('#boutique-content');
            hideSkeletons('#parametre-content');

            // --- Remplir les statistiques et dessiner le graphique ---
            if (data.stats) {
                drawChart(data.stats);
            } else {
                onChartError({ message: "Données de statistiques non trouvées." });
            }
            document.getElementById('stats-total-views').textContent = data.totalViews ?? 0;
            document.getElementById('stats-total-prospects').textContent = data.totalProspects ?? 0;

            // --- Remplir la section boutique ---
            if (data.products) {
                populateProductList(data.products);
            }
        }

        function getSocialLinksData() {
            const container = document.getElementById('social-links-container');
            const entries = container.querySelectorAll('.social-link-entry');
            const links = [];
            entries.forEach(entry => {
                const type = entry.querySelector('select').value;
                const url = entry.querySelector('input[type="text"]').value;
                if (url) {
                    links.push({ type, url });
                }
            });
            return JSON.stringify(links);
        }

        /**
         * Dessine le graphique une fois les données reçues de Google Sheets.
         * @param {object} stats - L'objet contenant {labels: [...], data: [...]}.
         */
        function drawChart(stats) {
            if (stats.error) {
                onChartError({ message: stats.error });
                return;
            }

            // Mettre à jour les chiffres dans les cartes de statistiques (basé sur le graphique des 7 derniers jours)
            const nfcIndex = stats.labels.indexOf('NFC');
            const qrIndex = stats.labels.indexOf('QR Code');
            const linkIndex = stats.labels.indexOf('Lien');
            document.getElementById('stats-nfc-views').textContent = nfcIndex !== -1 ? stats.data[nfcIndex] : 0;
            document.getElementById('stats-qr-views').textContent = qrIndex !== -1 ? stats.data[qrIndex] : 0;
            document.getElementById('stats-link-views').textContent = linkIndex !== -1 ? stats.data[linkIndex] : 0;

            const ctx = document.getElementById('viewsChart').getContext('2d');
            
            if (viewsChartInstance) {
                viewsChartInstance.destroy(); // Détruire l'ancienne instance du graphique
            }

            viewsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.labels,
                    datasets: [{
                        label: 'Vues par source',
                        data: stats.data,
                        backgroundColor: 'rgba(128, 128, 128, 0.5)',
                        borderColor: 'rgba(128, 128, 128, 0.8)',
                        hoverBackgroundColor: 'rgba(128, 128, 128, 0.7)',
                        hoverBorderColor: 'rgba(128, 128, 128, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'var(--card-bg)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y || 0;
                                    const plural = value > 1 ? 's' : '';
                                    return `${value} vue${plural} via ${context.label}`;
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'var(--text-secondary)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-secondary)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function onChartError(error) {
            console.error("Erreur lors de la récupération des données du graphique :", error.message);
            document.getElementById('viewsChart').parentElement.innerHTML += '<p style="color: var(--red);">Impossible de charger le graphique.</p>';
        }

        // Fonctions pour la modale
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Fonction pour la navigation dans la modale d'édition
        function showEditPane(paneId, clickedElement) {
            document.querySelectorAll('.edit-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(paneId).classList.add('active');
            document.querySelectorAll('.editor-nav-btn').forEach(btn => btn.classList.remove('active'));
            clickedElement.classList.add('active');
        }

        // Fonctions pour l'aperçu en direct
        document.getElementById('Nom_Complet').addEventListener('input', e => {
            document.getElementById('phone-name-preview').textContent = e.target.value || 'Nom Prénom';
        });
        document.getElementById('Profession').addEventListener('input', updatePhoneDetails);
        document.getElementById('Compagnie').addEventListener('input', updatePhoneDetails);
        document.getElementById('Location').addEventListener('input', updatePhoneDetails);

        // Ajout des écouteurs pour l'aperçu en direct des couleurs et polices
        document.getElementById('Couleur_Theme').addEventListener('input', e => {
            const themeColor = e.target.value;
            document.querySelector('.phone-header img').style.borderColor = themeColor;
            // Mettre à jour l'aperçu des boutons sociaux en direct
        });

        function updatePhoneDetails() {
            const parts = [document.getElementById('Profession').value, document.getElementById('Compagnie').value, document.getElementById('Location').value].filter(Boolean);
            document.getElementById('phone-details-preview').textContent = parts.join(' | ') || 'Profession';
        }

        function updatePhoneSocialLinks() {
            const container = document.getElementById('social-links-container');
            const previewContainer = document.getElementById('phone-social-links-preview');
            previewContainer.innerHTML = '';

            // Récupérer les couleurs actuelles des boutons pour l'aperçu
            const themeColor = document.getElementById('Couleur_Theme').value;
            const buttonTextColor = 'white'; // Texte blanc sur la couleur du thème pour les boutons

            const entries = container.querySelectorAll('.social-link-entry');
            // Nouvelle table de correspondance pour vos logos SVG
            const iconMap = {
                twitter: 'r/logo/1.svg',   // X
                linkedin: 'r/logo/2.svg',  // ln
                tiktok: 'r/logo/3.svg',    // tiktok
                youtube: 'r/logo/4.svg',   // youtube
                instagram: 'r/logo/5.svg', // instagramme
                whatsapp: 'r/logo/6.svg',  // whtasapp
                telegram: 'r/logo/7.svg',  // telegrame
                facebook: 'r/logo/8.svg',  // faceboo
                snapchat: 'r/logo/9.svg'   // sanpp
            };

            entries.forEach(entry => {
                const type = entry.querySelector('select').value;
                const url = entry.querySelector('input[type="text"]').value.trim();
                if (url) {
                    const iconSrc = iconMap[type]; // Récupère le chemin de votre SVG
                    const linkName = entry.querySelector('select').options[entry.querySelector('select').selectedIndex].text;
                    
                    // Utilise une balise <img> si un logo personnalisé existe
                    const iconHtml = iconSrc ? `<img src="${iconSrc}" class="social-icon">` : '';

                    previewContainer.innerHTML += `
                        <a href="#" class="phone-social-link">
                            <div style="background-color: ${themeColor}; border-radius: 15px; padding: 12px; display: inline-block;">${iconHtml}</div>
                            <span>${linkName}</span>
                        </a>
                    `;
                }
            });
        }

        function logout() {
            callApi('logout')
                .then(() => localStorage.removeItem('authToken')) // Supprimer le token
                .finally(() => window.location.href = 'index.html');
        }

        // --- Logique pour la Boutique ---

        function populateProductList(products) {
            const productListContainer = document.getElementById('product-list');
            productListContainer.innerHTML = ''; // Vider la liste
            if (products.length === 0) {
                productListContainer.innerHTML = '<p>Vous n\'avez encore ajouté aucun produit.</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'card';
                productCard.style.cursor = 'pointer';
                productCard.onclick = () => openProductModal(product);

                const imageUrl = (product.Images_JSON && JSON.parse(product.Images_JSON)[0]) ? JSON.parse(product.Images_JSON)[0] : 'https://placehold.co/300x200/333/ccc?text=Produit';

                productCard.innerHTML = `
                    <img src="${imageUrl}" alt="${product.Nom}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 5px 0;">${product.Nom}</h4>
                    <p style="margin: 0; font-weight: bold; color: var(--accent-color);">${product.Prix} €</p>
                `;
                productListContainer.appendChild(productCard);
            });
        }

        function openProductModal(product = null) {
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('product-modal-title').textContent = product ? 'Modifier le produit' : 'Ajouter un produit';
            document.getElementById('product-id').value = product ? product.ID : '';
            document.getElementById('product-name').value = product ? product.Nom : '';
            document.getElementById('product-price').value = product ? product.Prix : '';
            document.getElementById('product-description').value = product ? product.Description : '';
            
            // Gérer le bouton supprimer
            document.getElementById('product-delete-button').style.display = product ? 'inline-block' : 'none';

            // Gérer les images (simplifié pour l'instant, ne gère pas la modification des images existantes)
            // L'affichage des images existantes est maintenant géré.
            document.getElementById('product-image-previews').innerHTML = '';
            if (product && product.Images_JSON) {
                const images = JSON.parse(product.Images_JSON);
                images.forEach(imgUrl => {
                    document.getElementById('product-image-previews').innerHTML += `<img src="${imgUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;">`;
                });
            }

            openModal('product-modal');
        }

        async function handleProductSave(event) {
            event.preventDefault();
            const button = document.getElementById('product-save-button');
            button.disabled = true;
            button.textContent = 'Sauvegarde...';

            const form = document.getElementById('product-form');
            const imageInputs = form.querySelectorAll('input[type="file"]');
            const existingImages = Array.from(document.querySelectorAll('#product-image-previews img')).map(img => img.src);

            // 1. Uploader les nouvelles images
            const uploadPromises = Array.from(imageInputs)
                .filter(input => input.files[0])
                .map(input => uploadToImgBB(input.files[0]));

            try {
                const newImageUrls = await Promise.all(uploadPromises);

                // 2. Combiner les images
                const allImageUrls = [...existingImages, ...newImageUrls];

                // 3. Préparer les données du produit
                const productData = {
                    ID_Produit: document.getElementById('product-id').value,
                    Nom: document.getElementById('product-name').value,
                    Prix: document.getElementById('product-price').value,
                    Description: document.getElementById('product-description').value,
                    Images_JSON: allImageUrls
                };

                // 4. Appeler l'API pour sauvegarder
                const response = await callApi('saveProduct', { payload: productData });
                if (response.success) {
                    alert('Produit sauvegardé avec succès !');
                    closeModal('product-modal');
                    fetchDashboardData(); // Recharger les données pour voir le nouveau produit
                } else {
                    throw new Error(response.error || 'Erreur inconnue lors de la sauvegarde.');
                }
            } catch (error) {
                alert('Erreur lors de la sauvegarde du produit : ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Sauvegarder le produit';
            }
        }

        function handleProductDelete() {
            if (!confirm("Voulez-vous vraiment supprimer ce produit ? Cette action est irréversible.")) return;
            const productId = document.getElementById('product-id').value;
            callApi('deleteProduct', { ID_Produit: productId }).then(response => {
                alert(response.message || response.error);
                if (response.success) { closeModal('product-modal'); fetchDashboardData(); }
            });
        }

    </script>
</body>
</html> 